<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <title>Portal Berita — Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#f7f7fb;--card:#ffffff;--text:#222;--muted:#666;--accent:#f7b500;--accent2:#ffd84d;}
    body{margin:0;background:var(--bg);color:var(--text);font-family:'Poppins',sans-serif;}
    header{position:sticky;top:0;background:rgba(255,255,255,.8);backdrop-filter:blur(12px);padding:1rem 1.2rem;border-bottom:1px solid #eee;}
    main{max-width:980px;margin:1rem auto;padding:0 1rem;}
    .card{background:var(--card);border-radius:16px;box-shadow:0 4px 14px rgba(0,0,0,.06);padding:1rem;margin-bottom:1rem;}
    label{display:block;margin:.25rem 0 .2rem;font-weight:500;}
    input,select,textarea{width:100%;padding:.6rem .75rem;border:1px solid #ddd;border-radius:16px;font-family:inherit;}
    textarea{min-height:120px;}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:1rem;}
    .btn{display:inline-block;background:linear-gradient(135deg,var(--accent2),var(--accent));color:#000;border:none;padding:.6rem 1.1rem;border-radius:20px;font-weight:600;cursor:pointer;}
    .btn.secondary{background:#efefef;}
    .right{display:flex;gap:.5rem;justify-content:flex-end;flex-wrap:wrap;}
    table{width:100%;border-collapse:collapse;font-size:.9rem;}
    th,td{padding:.6rem;border-bottom:1px solid #eee;}
    .muted{color:var(--muted);font-size:.85rem;}
    .tag{padding:.2rem .5rem;background:#f2f2f2;border-radius:999px;font-size:.8rem;}
    .danger{color:#b00020;cursor:pointer;}
    .hidden{display:none;}
    #loadingOverlay{position:fixed;inset:0;background:rgba(255,255,255,0.7);display:none;justify-content:center;align-items:center;z-index:3000;}
    .spinner{width:50px;height:50px;border:4px solid #ddd;border-top:4px solid var(--accent);border-radius:50%;animation:spin 1s linear infinite;}
    #customModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:4000;}
    .modal-box{background:var(--card);color:var(--text);padding:1.5rem;border-radius:16px;max-width:300px;text-align:center;box-shadow:0 6px 18px rgba(0,0,0,.2);}
    .modal-box button{margin-top:1rem;}
  </style>
</head>
<body>
  <header><h1>Portal Berita — Admin</h1></header>
  <main>
    <div id="loginCard" class="card">
      <h3>Login Admin</h3>
      <input type="email" id="loginEmail" placeholder="Email">
      <input type="password" id="loginPassword" placeholder="Password">
      <button id="loginBtn" class="btn">Masuk</button>
      <div id="loginMsg" class="muted mt"></div>
    </div>

    <div id="formCard" class="card hidden">
      <h3 id="formTitle">Tambah Konten</h3>
      <div class="row">
        <div><label>Judul</label><input type="text" id="fJudul"></div>
        <div><label>Kategori</label><select id="fKategori"><option>Berita</option><option>Pengumuman</option><option>Peraturan</option></select></div>
      </div>
      <label>Isi Konten</label><textarea id="fIsi"></textarea>
      <div class="row">
        <div><label>Upload Gambar</label><input type="file" id="fFile" accept="image/*"><div class="muted">Upload otomatis ke Cloudinary.</div></div>
        <div><label>Gambar URL</label><input type="text" id="fGambarURL"></div>
      </div>
      <div class="row">
        <div><label>Status</label><select id="fStatus"><option>Aktif</option><option>Arsip</option><option>Hapus</option></select></div>
        <div><label>Slug</label><input type="text" id="fSlug"></div>
      </div>
      <div class="right mt"><button class="btn secondary" id="resetBtn">Bersihkan</button><button class="btn" id="saveBtn">Simpan</button><button class="btn secondary" id="logoutBtn">Logout</button></div>
      <div id="formMsg" class="muted mt"></div>
    </div>

    <div id="listCard" class="card hidden">
      <h3>Daftar Konten</h3>
      <table><thead><tr><th>Judul</th><th>Kategori</th><th>Tanggal</th><th>Status</th></tr></thead><tbody id="tbody"></tbody></table>
    </div>
  </main>

  <div id="loadingOverlay"><div class="spinner"></div></div>
  <div id="customModal"><div class="modal-box"><p id="modalMessage"></p><button onclick="closeModal()" class="btn">OK</button></div></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, getDocs, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = {apiKey:"AIzaSyDEGklPNtv-LvKzSW0d3QZRo5DMLr1nY-Y",authDomain:"portal-berita-firebase.firebaseapp.com",projectId:"portal-berita-firebase",storageBucket:"portal-berita-firebase.firebasestorage.app",messagingSenderId:"598254123187",appId:"1:598254123187:web:9418bcbe0a00dda3c3d8c6"};
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const CLOUD_NAME="dfojor5pr"; const UPLOAD_PRESET="portal-firebase";

    let EDIT_ID=null;
    function showLoading(on=true){document.getElementById("loadingOverlay").style.display=on?"flex":"none";}
    window.showModal=msg=>{document.getElementById("modalMessage").textContent=msg;document.getElementById("customModal").style.display="flex";}
    window.closeModal=()=>{document.getElementById("customModal").style.display="none";}

    onAuthStateChanged(auth,(user)=>{if(user){loginCard.classList.add("hidden");formCard.classList.remove("hidden");listCard.classList.remove("hidden");reloadList();}else{loginCard.classList.remove("hidden");formCard.classList.add("hidden");listCard.classList.add("hidden");}});

    loginBtn.onclick=async()=>{try{await signInWithEmailAndPassword(auth,loginEmail.value,loginPassword.value);}catch(e){loginMsg.textContent="Login gagal: "+e.message;}};
    logoutBtn.onclick=()=>signOut(auth);
    resetBtn.onclick=()=>resetForm();
    saveBtn.onclick=()=>submitForm();

    async function reloadList(){
      showLoading(true);
      const snap=await getDocs(collection(db,"posts"));
      showLoading(false);
      tbody.innerHTML="";
      snap.forEach(docSnap=>{
        const d=docSnap.data();
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${d.title}</td><td>${d.category}</td><td>${d.createdAt?d.createdAt.toDate().toLocaleDateString("id-ID"):""}</td><td><span class="tag">${d.status}</span></td>`;
        tbody.appendChild(tr);
      });
    }

    async function submitForm(){
      const title=fJudul.value.trim(), category=fKategori.value, content=fIsi.value.trim(), status=fStatus.value, slug=fSlug.value.trim(); let imageUrl=fGambarURL.value.trim();
      const file=fFile.files[0];
      if(file){const formData=new FormData();formData.append("file",file);formData.append("upload_preset",UPLOAD_PRESET);showLoading(true);const res=await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,{method:"POST",body:formData});const data=await res.json();showLoading(false);if(data.secure_url){imageUrl=data.secure_url;fGambarURL.value=imageUrl;}}
      const payload={title,category,content,status,slug,imageUrl,createdAt:serverTimestamp(),author:auth.currentUser.email};
      try{
        if(status==="Hapus" && EDIT_ID){await deleteDoc(doc(db,"posts",EDIT_ID));showModal("Konten dihapus permanen.");}
        else if(EDIT_ID){await updateDoc(doc(db,"posts",EDIT_ID),payload);showModal("Konten diperbarui.");}
        else{await addDoc(collection(db,"posts"),payload);showModal("Konten baru ditambahkan.");}
        resetForm();reloadList();
      }catch(err){showModal("Gagal: "+err.message);}
    }

    function resetForm(){EDIT_ID=null;fJudul.value="";fIsi.value="";fGambarURL.value="";fSlug.value="";fKategori.value="Berita";fStatus.value="Aktif";fFile.value="";}
  </script>
</body>
</html>
